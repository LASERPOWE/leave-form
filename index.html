<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>Leave Application Form</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      label {
        font-weight: bold;
      }
      input, select, textarea {
        width: 100%;
        padding: 6px;
        margin: 8px 0;
      }
      .form-section {
        border: 1px solid #ddd;
        padding: 15px;
        margin-top: 20px;
        border-radius: 6px;
      }
      .btn {
        padding: 10px 20px;
        background-color: #4285f4;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h2>Leave Application Form</h2>

    <label>Enter EMP_CODE:</label>
    <input type="text" id="empCodeInput" placeholder="Enter Employee Code">
    <button class="btn" onclick="fetchEmployee()">Fetch Details</button>

    <div id="empDetails" class="form-section" style="display:none;">
      <label>Employee Name:</label>
      <select id="empNameDropdown" onchange="selectEmployee()"></select>

      <div id="empInfo"></div>

      <form id="leaveForm" onsubmit="submitForm(event)">
        <label>Leave Type:</label>
        <select id="leaveType" required>
          <option value="">-- Select Leave Type --</option>
          <option value="CL">CL</option>
          <option value="SL">SL</option>
          <option value="COFF">COFF</option>
        </select>

        <label>From Date:</label>
        <input type="date" id="fromDate" required>

        <label>To Date:</label>
        <input type="date" id="toDate" required>

        <label>Reason:</label>
        <textarea id="reason" rows="3" required></textarea>

        <button class="btn" type="submit">Submit Leave Request</button>
      </form>
    </div>

    <div id="message"></div>

    <script>
      let allEmployees = [];

      function fetchEmployee() {
        const empCode = document.getElementById('empCodeInput').value.trim();
        if (!empCode) {
          alert("Please enter EMP_CODE");
          return;
        }

        fetch(`https://script.google.com/macros/s/AKfycby4fCr8tZTN63ypNxGUeparjkR8BhAYwNRde_LaZ-7XafTPKABGWagdEza8YoPOrrWuUA/exec?emp_code=${empCode}`)
          .then(res => res.json())
          .then(data => {
            if (!data.found) {
              alert("Employee not found");
              return;
            }
            allEmployees = data.employees;
            populateDropdown();
            document.getElementById('empDetails').style.display = 'block';
          })
          .catch(err => {
            console.error(err);
            alert("Failed to fetch data");
          });
      }

      function populateDropdown() {
        const dropdown = document.getElementById("empNameDropdown");
        dropdown.innerHTML = "";
        allEmployees.forEach((emp, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = emp.emp_name;
          dropdown.appendChild(opt);
        });
        selectEmployee();
      }

      function selectEmployee() {
        const selected = allEmployees[document.getElementById("empNameDropdown").value];
        const infoDiv = document.getElementById("empInfo");
        infoDiv.innerHTML = `
          <p><b>Category:</b> ${selected.emp_catg_name}</p>
          <p><b>Designation:</b> ${selected.desig_name}</p>
          <p><b>Department:</b> ${selected.dept_name}</p>
          <p><b>HOD:</b> ${selected.hod}</p>
          <p><b>CL:</b> ${selected.cl} | <b>SL:</b> ${selected.sl} | <b>COFF:</b> ${selected.coff}</p>
          <p><b>Total:</b> ${selected.total_leave} | <b>Balance:</b> ${selected.balance}</p>
        `;
      }

      function submitForm(e) {
        e.preventDefault();
        const selected = allEmployees[document.getElementById("empNameDropdown").value];

        const payload = {
          emp_code: selected.emp_code,
          emp_catg_name: selected.emp_catg_name,
          emp_name: selected.emp_name,
          hod: selected.hod,
          desig_name: selected.desig_name,
          dept_name: selected.dept_name,
          leave_type: document.getElementById("leaveType").value,
          from_date: document.getElementById("fromDate").value,
          to_date: document.getElementById("toDate").value,
          reason: document.getElementById("reason").value,
          leave_count: calculateLeaveDays(),
          hod_mail: selected.hod_mail,
          user_mail: selected.user_mail || "" // optional
        };

        fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
          method: "POST",
          body: JSON.stringify(payload),
          headers: { "Content-Type": "application/json" }
        })
        .then(res => res.text())
        .then(msg => {
          document.getElementById("message").innerHTML = `<p><b>${msg}</b></p>`;
          document.getElementById("leaveForm").reset();
        })
        .catch(err => {
          console.error(err);
          document.getElementById("message").innerHTML = `<p style="color:red;"><b>Submission failed.</b></p>`;
        });
      }

      function calculateLeaveDays() {
        const from = new Date(document.getElementById("fromDate").value);
        const to = new Date(document.getElementById("toDate").value);
        const diff = (to - from) / (1000 * 3600 * 24) + 1;
        return diff > 0 ? diff : 0;
      }
    </script>
  </body>
</html>
